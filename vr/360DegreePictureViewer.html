<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kiyoshi's VR 360 Tour</title>
    
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Oswald:wght@700&display=swap" rel="stylesheet">
    
    <script>
        // --- 自定義攝影機控制元件 (解決手機無法垂直滑動問題) ---
        AFRAME.registerComponent('drag-look-controls', {
            schema: {
                speed: { default: 1.5 } // 滑動靈敏度
            },
            init: function () {
                this.yaw = 0;
                this.pitch = 0;
                this.isDragging = false;
                this.startX = 0;
                this.startY = 0;
                
                // 綁定事件
                this.onMouseDown = this.onMouseDown.bind(this);
                this.onMouseMove = this.onMouseMove.bind(this);
                this.onMouseUp = this.onMouseUp.bind(this);
                this.onTouchStart = this.onTouchStart.bind(this);
                this.onTouchMove = this.onTouchMove.bind(this);
                this.onTouchEnd = this.onTouchEnd.bind(this);

                this.addEventListeners();
            },
            addEventListeners: function () {
                var canvasEl = this.el.sceneEl.canvas;
                
                // 如果 Canvas 還沒準備好，監聽 window 也可以
                window.addEventListener('mousedown', this.onMouseDown);
                window.addEventListener('mousemove', this.onMouseMove);
                window.addEventListener('mouseup', this.onMouseUp);
                
                window.addEventListener('touchstart', this.onTouchStart, {passive: false});
                window.addEventListener('touchmove', this.onTouchMove, {passive: false});
                window.addEventListener('touchend', this.onTouchEnd);
            },
            updateRotation: function (deltaX, deltaY) {
                // 計算旋轉量 (包含靈敏度調整)
                // 這裡實作 "Reverse Drag" (拖曳畫面感)：
                // 手指往左(負)，視角要往右看(Yaw減少) -> 加上負數 = 減少
                // 手指往上(負)，視角要往下看(Pitch減少) -> 加上負數 = 減少
                var speed = this.data.speed * 0.002; // 係數微調

                this.yaw += deltaX * speed;
                this.pitch += deltaY * speed;

                // 限制垂直視角 (避免翻轉)，約上下 85 度
                this.pitch = Math.max(-1.5, Math.min(1.5, this.pitch));

                // 套用到 A-Frame 攝影機物件 (使用弧度)
                this.el.object3D.rotation.y = this.yaw;
                this.el.object3D.rotation.x = this.pitch;
            },
            // --- 滑鼠事件 ---
            onMouseDown: function (e) {
                this.isDragging = true;
                this.startX = e.clientX;
                this.startY = e.clientY;
            },
            onMouseMove: function (e) {
                if (!this.isDragging) return;
                var deltaX = e.clientX - this.startX;
                var deltaY = e.clientY - this.startY;
                this.startX = e.clientX;
                this.startY = e.clientY;
                this.updateRotation(deltaX, deltaY);
            },
            onMouseUp: function () {
                this.isDragging = false;
            },
            // --- 觸控事件 ---
            onTouchStart: function (e) {
                if (e.touches.length === 1) {
                    this.isDragging = true;
                    this.startX = e.touches[0].clientX;
                    this.startY = e.touches[0].clientY;
                }
            },
            onTouchMove: function (e) {
                if (!this.isDragging || e.touches.length !== 1) return;
                // 防止手機瀏覽器預設的捲動行為
                e.preventDefault(); 
                
                var deltaX = e.touches[0].clientX - this.startX;
                var deltaY = e.touches[0].clientY - this.startY;
                this.startX = e.touches[0].clientX;
                this.startY = e.touches[0].clientY;
                this.updateRotation(deltaX, deltaY);
            },
            onTouchEnd: function () {
                this.isDragging = false;
            },
            remove: function () {
                // 清除事件監聽 (良好的程式習慣)
                window.removeEventListener('mousedown', this.onMouseDown);
                window.removeEventListener('mousemove', this.onMouseMove);
                window.removeEventListener('mouseup', this.onMouseUp);
                window.removeEventListener('touchstart', this.onTouchStart);
                window.removeEventListener('touchmove', this.onTouchMove);
                window.removeEventListener('touchend', this.onTouchEnd);
            }
        });
    </script>
    
    <style>
        /* --- 基礎樣式 --- */
        body {
            margin: 0; padding: 0; background-color: #000;
            width: 100vw; height: 100vh; overflow: hidden;
            font-family: 'Noto Sans JP', sans-serif;
            /* 防止手機雙擊縮放干擾 */
            touch-action: none; 
        }

        /* --- 全螢幕容器 --- */
        #vr-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #333;
        }

        a-scene { width: 100%; height: 100%; }

        /* --- Loading 遮罩 --- */
        #loader-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #fff; transition: opacity 0.5s ease;
        }
        .loader-text { font-family: 'Oswald', sans-serif; font-size: 24px; letter-spacing: 2px; margin-bottom: 10px; text-align: center; padding: 0 20px;}
        .loader-bar-bg { width: 300px; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .loader-bar-fill { width: 0%; height: 100%; background: #007BFF; transition: width 0.2s; }
        .loader-percent { margin-top: 10px; font-size: 14px; color: #888; }

        /* --- 漢堡按鈕 --- */
        #menu-button {
            position: absolute; top: 20px; left: 20px; width: 44px; height: 44px; cursor: pointer; z-index: 5000;
            background: rgba(0, 0, 0, 0.5); border-radius: 8px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; transition: background 0.3s; 
            -webkit-tap-highlight-color: transparent; border: 1px solid rgba(255,255,255,0.2);
        }
        #menu-button:hover { background: rgba(0, 0, 0, 0.8); }
        .menu-line { width: 24px; height: 3px; background-color: #fff; border-radius: 2px; margin: 2px 0; transition: all 0.4s ease; position: relative; }
        #menu-button.open .menu-line:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); background-color: #007BFF; }
        #menu-button.open .menu-line:nth-child(2) { opacity: 0; }
        #menu-button.open .menu-line:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); background-color: #007BFF; }

        /* --- 選單遮罩 --- */
        #menu-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(10px); z-index: 4000;
            display: none; flex-direction: column; align-items: center; padding: 60px 20px 20px 20px;
            box-sizing: border-box; opacity: 0; transition: opacity 0.3s ease; overflow-y: auto;
        }
        #menu-overlay.show { display: flex !important; opacity: 1; }

        /* --- 選單樣式 --- */
        .menu-title { color: #007BFF; font-family: 'Oswald', sans-serif; font-size: 18px; margin-bottom: 15px; letter-spacing: 2px; border-bottom: 1px solid #444; padding-bottom: 5px; width: 100%; max-width: 800px; text-align: center; margin-top: 10px; }
        
        .menu-controls { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; justify-content: center; }
        .control-btn {
            padding: 8px 20px; border: 1px solid #444; border-radius: 20px;
            color: #888; cursor: pointer; font-family: 'Oswald', sans-serif; letter-spacing: 1px;
            transition: all 0.3s; background: rgba(255,255,255,0.05); min-width: 40px; text-align: center;
        }
        .control-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .control-btn.active { background: #007BFF; color: #fff; border-color: #007BFF; box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); }

        /* 縮圖網格 */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; width: 100%; max-width: 1200px; }
        .thumb-item {
            position: relative; cursor: pointer; border-radius: 8px; overflow: hidden;
            border: 2px solid transparent; transition: all 0.3s ease; aspect-ratio: 16 / 9;
        }
        .thumb-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .thumb-item:hover { border-color: #007BFF; box-shadow: 0 0 15px rgba(0, 123, 255, 0.4); }
        .thumb-item:hover img { transform: scale(1.1); }
        .thumb-item.active-scene { border-color: #007BFF; box-shadow: 0 0 15px rgba(0, 123, 255, 0.6); }
        .thumb-label { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: #fff; font-size: 12px; padding: 5px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* 場景名稱 */
        #current-scene-info {
            position: absolute; bottom: 20px; left: 20px; z-index: 100;
            color: rgba(255,255,255,0.8); font-family: 'Oswald', sans-serif;
            text-shadow: 1px 1px 3px #000; pointer-events: none;
            background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2); font-size: 14px; letter-spacing: 1px;
        }
    </style>
</head>
<body>

    <div id="vr-container">
        <div id="loader-mask">
            <div class="loader-text">Loading Files of "Kiyoshi's VR 360 Tour"</div>
            <div class="loader-bar-bg">
                <div class="loader-bar-fill" id="progress-bar"></div>
            </div>
            <div class="loader-percent" id="progress-text">0%</div>
        </div>

        <div id="menu-button">
            <div class="menu-line"></div>
            <div class="menu-line"></div>
            <div class="menu-line"></div>
        </div>

        <div id="menu-overlay">
            
            <div class="menu-title">AUTO ROTATION SPEED</div>
            <div class="menu-controls">
                <div class="control-btn" id="btn-speed-0" onclick="setSpeed(0)">OFF</div>
                <div class="control-btn" id="btn-speed-1" onclick="setSpeed(1)">1x</div>
                <div class="control-btn active" id="btn-speed-2" onclick="setSpeed(2)">2x</div>
                <div class="control-btn" id="btn-speed-3" onclick="setSpeed(3)">3x</div>
            </div>

            <div class="menu-title">SELECT A SCENE</div>
            <div class="grid-container" id="thumbnail-grid"></div>
        </div>

        <div id="current-scene-info">Scene Name</div>

        <a-scene embedded vr-mode-ui="enabled: false" loading-screen="enabled: false">
            <a-assets>
                <img id="sky-texture" src="" crossorigin="anonymous">
            </a-assets>

            <a-sky id="main-sky" src="#sky-texture" rotation="0 -90 0"></a-sky>
            
            <a-entity camera drag-look-controls></a-entity>
        </a-scene>
    </div>

    <script>
        const baseUrl = "https://kiyoshichang.github.io/code/vr/";
        
        // --- 完整圖片清單 (含中文名稱) ---
        const imageFiles = [
            { file: "20250409TaoYuanFlowers32_360Degree_5952.jpg", name: "2025桃園彩色海芋季「奇芋夢幻島」" },
            { file: "20250411SooChowUniversity08_360Degree_5952.jpg", name: "東呉大學城區部(日間)" },
            { file: "20250411SooChowUniversity09_360Degree_5952.jpg", name: "東呉大學城區部(籃球場)" },
            { file: "20250420Tainan055_360Degree_5952.jpg", name: "2025西拉雅森活節(官田遊客中心)" },
            { file: "20250420Tainan106_360Degree_5952.jpg", name: "臺南藝術大學" },
            { file: "20250420Tainan139_360Degree_5952.jpg", name: "南臺科技大學" },
            { file: "20250420Tainan217_360Degree_11968.jpg", name: "奇美博物館" },
            { file: "20250429MiaoLi057_360Degree_5952.jpg", name: "苗栗火車頭園區" },
            { file: "20250430ShilinFlowers12_360Degree_5952.jpg", name: "士林官邸Rose Garden" },
            { file: "20250430ShilinSooChouUniversity06_360Degree_5952.jpg", name: "東呉大學外雙溪園區(校名大字)" },
            { file: "20250430ShilinSooChouUniversity14_360Degree_5952.jpg", name: "東呉大學外雙溪園區(第二教學研究大樓)" },
            { file: "20250430SooChowUniversity02_360Degree_11968.jpg", name: "東呉大學城區部(夜間)" },
            { file: "20250513Nantou027_360Degree_5952.jpg", name: "日月潭生態園區金針花" },
            { file: "20250531LoversFlower37_360Degree_5952.jpg", name: "内雙溪自然中心愛情花季" },
            { file: "20250712TaiTung039_360Degree_5952.jpg", name: "2025年7月熱氣球嘉年華@鹿野高台" },
            { file: "20250721TravelingExpo14_360Degree_5952.jpg", name: "2025揆衆夏季旅展@世貿一館" },
            { file: "20250816TaiTung037_360Degree_5952.jpg", name: "2025年8月熱氣球嘉年華@鹿野高台" },
            { file: "20251003HsinChu58_360Degree_5952.jpg", name: "2025新竹市國際風箏節「箏霸星際」" },
            { file: "20251129ShiLinChrysanthemum46_360Degree_5952.jpg", name: "2025士林官邸菊花展-玩具士兵" },
            { file: "20251217XmasHsinYiDist14_360Degree_5952.jpg", name: "2025統一時代百貨iSharing X'mas" },
            { file: "20251223HsinChu25_360Degree_5952.jpg", name: "味衛佳柿餅教育農園" },
            { file: "20251230ChiaYi28_360Degree_5952.jpg", name: "嘉義大林情投義和花海節" },
            { file: "20251230Tainan62_360Degree_5952.jpg", name: "台南藏金閣2館-1" },
            { file: "20251230Tainan63_360Degree_5952.jpg", name: "台南藏金閣2館-2" }
        ];

        let loadedCount = 0;
        const totalImages = imageFiles.length;
        let currentImageIndex = -1;
        
        // --- 旋轉控制變數 ---
        const baseSpeed = 0.001; 
        let speedMultiplier = 2; // 預設 2x
        
        const skyEl = document.getElementById('main-sky');

        // --- 1. 預載 ---
        function startPreloading() {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            imageFiles.forEach((item) => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => {
                    loadedCount++;
                    const percent = Math.round((loadedCount / totalImages) * 100);
                    progressBar.style.width = percent + '%';
                    progressText.innerText = percent + '%';

                    if (loadedCount === totalImages) {
                        setTimeout(initExperience, 500);
                    }
                };
                img.onerror = () => {
                    loadedCount++;
                    if (loadedCount === totalImages) initExperience();
                };
                img.src = baseUrl + item.file;
            });
        }

        function initExperience() {
            const mask = document.getElementById('loader-mask');
            mask.style.opacity = 0;
            setTimeout(() => { mask.style.display = 'none'; }, 500);

            buildMenu();
            
            // 隨機選一張開始
            const randomIndex = Math.floor(Math.random() * totalImages);
            changeScene(randomIndex);

            // 啟動動畫迴圈
            requestAnimationFrame(animateLoop);
        }

        // --- 2. 場景切換 ---
        function changeScene(index) {
            currentImageIndex = index;
            
            const item = imageFiles[index];
            const fullUrl = baseUrl + item.file;
            const displayName = item.name;

            const tempImg = new Image();
            tempImg.crossOrigin = "anonymous";
            tempImg.onload = function() {
                skyEl.setAttribute('src', fullUrl);
            };
            tempImg.src = fullUrl;

            document.getElementById('current-scene-info').innerText = displayName;
            updateMenuState();
        }

        // --- 3. 速度控制邏輯 ---
        function setSpeed(multiplier) {
            speedMultiplier = multiplier;
            
            document.querySelectorAll('.menu-controls .control-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn-speed-' + multiplier).classList.add('active');
        }

        // --- 4. 動畫迴圈 ---
        function animateLoop() {
            if (speedMultiplier > 0 && skyEl.object3D) {
                // 注意：這裡使用加法來旋轉，與拖曳邏輯分開
                skyEl.object3D.rotation.y += baseSpeed * speedMultiplier;
            }
            requestAnimationFrame(animateLoop);
        }

        // --- 5. 選單 UI ---
        function buildMenu() {
            const grid = document.getElementById('thumbnail-grid');
            grid.innerHTML = ''; 

            imageFiles.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'thumb-item';
                div.dataset.index = index;
                div.onclick = () => {
                    changeScene(index);
                    toggleMenu();
                };

                const img = document.createElement('img');
                img.crossOrigin = "anonymous"; 
                img.src = baseUrl + item.file;
                img.loading = "lazy"; 

                const label = document.createElement('div');
                label.className = 'thumb-label';
                label.innerText = item.name;

                div.appendChild(img);
                div.appendChild(label);
                grid.appendChild(div);
            });
        }

        function updateMenuState() {
            document.querySelectorAll('.thumb-item').forEach(item => {
                const idx = parseInt(item.dataset.index);
                if (idx === currentImageIndex) item.classList.add('active-scene');
                else item.classList.remove('active-scene');
            });
        }

        function toggleMenu() {
            const $btn = $('#menu-button');
            const $overlay = $('#menu-overlay');
            if ($btn.hasClass('open')) {
                $btn.removeClass('open');
                $overlay.removeClass('show');
                setTimeout(function(){ $overlay.hide(); }, 300);
            } else {
                $overlay.css('display', 'flex'); 
                setTimeout(function(){ $btn.addClass('open'); $overlay.addClass('show'); }, 10);
            }
        }
        $('#menu-button').on('click', toggleMenu);
        document.addEventListener('contextmenu', e => e.preventDefault());

        window.onload = startPreloading;
    </script>
</body>
</html>